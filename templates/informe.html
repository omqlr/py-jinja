{% extends "base.html" %}

{% block titulo %}Informe de Incidencias del Sistema{% endblock %}

{% block contenido %}

<h2>ğŸ“Š Filtros</h2>
<div class="filtros">
  <form method="get" action="/informe">
    <label>
      CategorÃ­a:
      <select name="categoria">
        <option value="" {% if not categoria %}selected{% endif %}>(Todas)</option>
        <option value="red" {% if categoria=="red" %}selected{% endif %}>ğŸŒ Red</option>
        <option value="hardware" {% if categoria=="hardware" %}selected{% endif %}>ğŸ’» Hardware</option>
        <option value="software" {% if categoria=="software" %}selected{% endif %}>âš™ï¸ Software</option>
      </select>
    </label>

    <label>
      Gravedad mÃ­nima:
      <input type="number" name="min_gravedad" min="1" max="5" value="{{ min_gravedad }}" />
    </label>

    <button type="submit">ğŸ” Aplicar filtros</button>
  </form>
</div>

<h2>ğŸ“ˆ Resumen</h2>
<div style="background: #f8f9ff; padding: 1.5rem; border-radius: 10px; margin-bottom: 2rem;">
  <ul style="list-style: none; display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
    <li style="background: white; padding: 1rem; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
      <strong style="color: #667eea; font-size: 2rem;">{{ resumen.total }}</strong><br>
      <span style="color: #666;">Total de incidencias</span>
    </li>
    <li style="background: white; padding: 1rem; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
      <strong style="color: #10b981; font-size: 2rem;">{{ resumen.resueltas }}</strong><br>
      <span style="color: #666;">Incidencias resueltas</span>
    </li>
    <li style="background: white; padding: 1rem; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
      <strong style="color: #ef4444; font-size: 2rem;">{{ resumen.pendientes }}</strong><br>
      <span style="color: #666;">Incidencias pendientes</span>
    </li>
    <li style="background: white; padding: 1rem; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
      <strong style="color: #667eea; font-size: 2rem;">{{ resumen.porcentaje_resueltas }}%</strong><br>
      <span style="color: #666;">Porcentaje resueltas</span>
    </li>
  </ul>
</div>

<h2>ğŸ“‹ Detalle de Incidencias</h2>
<table>
  <thead>
    <tr>
      <th>ID</th>
      <th>TÃ­tulo</th>
      <th>DescripciÃ³n</th>
      <th>CategorÃ­a</th>
      <th>Gravedad</th>
      <th>Estado</th>
    </tr>
  </thead>
  <tbody>
    {% for inc in incidencias %}
    <tr>
      <td><strong>#{{ inc.id }}</strong></td>
      <td>{{ inc.titulo }}</td>
      <td style="color: #666;">{{ inc.descripcion }}</td>
      <td>
        {% if inc.categoria == "red" %}
        ğŸŒ Red
        {% elif inc.categoria == "hardware" %}
        ğŸ’» Hardware
        {% else %}
        âš™ï¸ Software
        {% endif %}
      </td>
      <td>
        <span style="
          background: {% if inc.gravedad >= 4 %}#ef4444{% elif inc.gravedad == 3 %}#f59e0b{% else %}#10b981{% endif %};
          color: white;
          padding: 0.3rem 0.8rem;
          border-radius: 20px;
          font-weight: 600;
        ">
          {{ inc.gravedad }}/5
        </span>
      </td>
      <td>
        {% if inc.resuelta %}
        <span style="color: #10b981; font-weight: 600;">âœ… Resuelta</span>
        {% else %}
        <span style="color: #ef4444; font-weight: 600;">â³ Pendiente</span>
        {% endif %}
      </td>
    </tr>
    {% endfor %}
    {% if incidencias|length == 0 %}
    <tr>
      <td colspan="6" style="text-align: center; padding: 2rem; color: #999;">
        No hay incidencias que cumplan los filtros seleccionados.
      </td>
    </tr>
    {% endif %}
  </tbody>
</table>

<!-- SecciÃ³n de grÃ¡ficos -->
<div style="margin-top: 3rem;">
  <h2>ğŸ“Š GrÃ¡fico 1: Incidencias por CategorÃ­a</h2>
  <div
    style="background: white; padding: 2rem; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 2rem;">
    <canvas id="graficoCategoria" width="800" height="300"></canvas>
  </div>

  <!-- âœ¨ MODIFICACIÃ“N OBLIGATORIA: Segundo grÃ¡fico (Pie Chart) âœ¨ -->
  <h2>ğŸ¥§ GrÃ¡fico 2: Estado de ResoluciÃ³n (Resueltas vs Pendientes)</h2>
  <div style="background: white; padding: 2rem; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
    <canvas id="graficoEstado" width="400" height="400"></canvas>
  </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  // GrÃ¡fico 1: Incidencias por categorÃ­a (Bar Chart)
  const labelsCategoria = {{ labels_categorias | tojson }};
  const valoresCategoria = {{ valores_categorias | tojson }};

  const ctxCategoria = document.getElementById("graficoCategoria").getContext("2d");
  new Chart(ctxCategoria, {
    type: "bar",
    data: {
      labels: labelsCategoria.map(cat => {
        if (cat === 'red') return 'ğŸŒ Red';
        if (cat === 'hardware') return 'ğŸ’» Hardware';
        return 'âš™ï¸ Software';
      }),
      datasets: [
        {
          label: "NÃºmero de incidencias",
          data: valoresCategoria,
          backgroundColor: [
            "rgba(102, 126, 234, 0.8)",
            "rgba(118, 75, 162, 0.8)",
            "rgba(237, 100, 166, 0.8)",
          ],
          borderColor: [
            "rgba(102, 126, 234, 1)",
            "rgba(118, 75, 162, 1)",
            "rgba(237, 100, 166, 1)",
          ],
          borderWidth: 2,
        },
      ],
    },
    options: {
      responsive: true,
      plugins: {
        legend: {
          display: true,
          position: 'top',
        },
        title: {
          display: true,
          text: 'DistribuciÃ³n de Incidencias por CategorÃ­a',
          font: {
            size: 16,
            weight: 'bold'
          }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            stepSize: 1
          }
        },
      },
    },
  });

  // âœ¨ GrÃ¡fico 2: Estado de resoluciÃ³n (Pie Chart) - MODIFICACIÃ“N OBLIGATORIA âœ¨
  const labelsEstado = {{ labels_estado | tojson }};
  const valoresEstado = {{ valores_estado | tojson }};

  const ctxEstado = document.getElementById("graficoEstado").getContext("2d");
  new Chart(ctxEstado, {
    type: "pie",
    data: {
      labels: labelsEstado,
      datasets: [
        {
          label: "Incidencias",
          data: valoresEstado,
          backgroundColor: [
            "rgba(16, 185, 129, 0.8)",  // Verde para resueltas
            "rgba(239, 68, 68, 0.8)",    // Rojo para pendientes
          ],
          borderColor: [
            "rgba(16, 185, 129, 1)",
            "rgba(239, 68, 68, 1)",
          ],
          borderWidth: 2,
        },
      ],
    },
    options: {
      responsive: true,
      plugins: {
        legend: {
          display: true,
          position: 'bottom',
        },
        title: {
          display: true,
          text: 'Porcentaje de Incidencias Resueltas vs Pendientes',
          font: {
            size: 16,
            weight: 'bold'
          }
        },
        tooltip: {
          callbacks: {
            label: function (context) {
              let label = context.label || '';
              let value = context.parsed || 0;
              let total = context.dataset.data.reduce((a, b) => a + b, 0);
              let percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
              return label + ': ' + value + ' (' + percentage + '%)';
            }
          }
        }
      },
    },
  });
</script>

{% endblock %}